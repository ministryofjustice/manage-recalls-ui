{% extends "../partials/layout.njk" %}

{% set pageTitle = applicationName + " - Recalls" %}

{% block content %}

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-full">
            {% if errors %}
                {{ govukErrorSummary({
                    titleText: "There is a problem",
                    errorList: errors.list,
                    attributes: {
                        'data-qa': 'error-list'
                    }
                }) }}
            {% endif %}
            <h1 class="govuk-heading-xl">
                Recalls
            </h1>

            {% set toDoHtml %}
            {% if results and results.toDo.length > 0 %}
                <table class="govuk-table">
                    <caption class="govuk-table__caption govuk-table__caption--l" data-qa="toDo-list-heading">
                        To do
                    </caption>
                    <thead class="govuk-table__head">
                    <tr class="govuk-table__row">
                        <th scope="col" class="govuk-table__header">Name</th>
                        <th scope="col" class="govuk-table__header">Due</th>
                        <th scope="col" class="govuk-table__header">Assigned to</th>
                        <th scope="col" class="govuk-table__header">Action</th>
                        <th scope="col" class="govuk-table__header"><span class='govuk-visually-hidden'>View recall</span></th>
                    </tr>
                    </thead>
                    <tbody class="govuk-table__body" data-qa="search-results">
                    {% for result in results.toDo %}
                        <tr class="govuk-table__row" data-qa='recall-id-{{ result.recall.recallId }}'>
                            <td class="govuk-table__cell"
                                data-qa="name">{{ result.person.firstName }} {{ result.person.lastName }}</td>
                            <td class="govuk-table__cell" data-qa="dueDate">
                                {% if result.recall.status == 'RECALL_NOTIFICATION_ISSUED' or result.recall.status == 'DOSSIER_IN_PROGRESS' %}
                                {{ dueDateLabel({ dueIsoDateTime: result.recall.dossierTargetDate, includeTime: false, shortFormat: true }) }}

                                {% elseif result.recall.recallAssessmentDueDateTime %}
                                {{ dueDateLabel({ dueIsoDateTime: result.recall.recallAssessmentDueDateTime, includeTime: true, shortFormat: true }) }}
                                {% endif %}
                            </td>
                            <td class="govuk-table__cell" data-qa="assignedTo">{{ result.recall.assigneeUserName }}</td>
                            <td class="govuk-table__cell">
                                {% set person = result.person %}
                                {% set recall = result.recall %}
                                {% include "../partials/recallActionLink.njk" %}
                            </td>
                            <td class="govuk-table__cell">
                                <a href='/persons/{{person.nomsNumber}}/recalls/{{recall.recallId}}/view-recall' data-qa='view-recall-{{ recall.recallId }}'>View recall</a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p class='govuk-body'>No recalls</p>
            {% endif %}
            {% endset -%}

            {% set completedHtml %}
                {% if results and results.completed.length > 0 %}
                    <table class="govuk-table">
                        <caption class="govuk-table__caption govuk-table__caption--l" data-qa="completed-list-heading">
                            Completed
                        </caption>
                        <thead class="govuk-table__head">
                        <tr class="govuk-table__row">
                            <th scope="col" class="govuk-table__header">Name</th>
                            <th scope="col" class="govuk-table__header">Date</th>
                            <th scope="col" class="govuk-table__header">Status</th>
                            <th scope="col" class="govuk-table__header">Action</th>
                        </tr>
                        </thead>
                        <tbody class="govuk-table__body" data-qa="search-results">
                        {% for result in results.completed %}
                            <tr class="govuk-table__row" data-qa='recall-id-{{ result.recall.recallId }}'>
                                <td class="govuk-table__cell"
                                    data-qa="name">{{ result.person.firstName }} {{ result.person.lastName }}</td>
                                <td class="govuk-table__cell" data-qa="completedDate">
                                    {% if result.recall.status == 'DOSSIER_ISSUED'%}{{ result.recall.dossierEmailSentDate | dateTime }}{% elif result.recall.status == 'STOPPED'%}{{ result.recall.lastUpdatedDateTime | dateOnly }}{% endif %}
                                </td>
                                <td class="govuk-table__cell" data-qa="assignedTo">{% if result.recall.status == 'DOSSIER_ISSUED'%}Dossier issued{% elif result.recall.status == 'STOPPED'%}Stopped{% endif %}</td>
                                <td class="govuk-table__cell">
                                    <a href='/persons/{{result.person.nomsNumber}}/recalls/{{result.recall.recallId}}/view-recall?fromPage=/&fromHash=completed' data-qa='view-recall-{{ result.recall.recallId }}'>View recall</a>
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class='govuk-body'>No recalls</p>
                {% endif %}
            {% endset -%}
            {{ govukTabs({
                items: [
                    {
                        label: "To do (" + results.toDo.length + ")",
                        id: "to-do",
                        panel: {
                        html: toDoHtml
                    }
                    },
                    {
                        label: "Completed (" + results.completed.length + ")",
                        id: "completed",
                        panel: {
                        html: completedHtml
                    }
                    }
                ]
            }) }}
        </div>
    </div>

{% endblock %}
